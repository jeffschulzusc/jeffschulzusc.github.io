var oidc=(()=>{var He=Object.create;var $=Object.defineProperty;var Be=Object.getOwnPropertyDescriptor;var Je=Object.getOwnPropertyNames;var Ke=Object.getPrototypeOf,Ve=Object.prototype.hasOwnProperty;var ve=d=>$(d,"__esModule",{value:!0});var be=(d=>typeof require!="undefined"?require:typeof Proxy!="undefined"?new Proxy(d,{get:(e,t)=>(typeof require!="undefined"?require:e)[t]}):d)(function(d){if(typeof require!="undefined")return require.apply(this,arguments);throw new Error('Dynamic require of "'+d+'" is not supported')});var G=(d,e)=>()=>(e||d((e={exports:{}}).exports,e),e.exports),De=(d,e)=>{ve(d);for(var t in e)$(d,t,{get:e[t],enumerable:!0})},ze=(d,e,t)=>{if(e&&typeof e=="object"||typeof e=="function")for(let r of Je(e))!Ve.call(d,r)&&r!=="default"&&$(d,r,{get:()=>e[r],enumerable:!(t=Be(e,r))||t.enumerable});return d},ye=d=>ze(ve($(d!=null?He(Ke(d)):{},"default",d&&d.__esModule&&"default"in d?{get:()=>d.default,enumerable:!0}:{value:d,enumerable:!0})),d);var we=G(()=>{});var re=G((Y,ke)=>{(function(d,e){typeof Y=="object"?ke.exports=Y=e():typeof define=="function"&&define.amd?define([],e):d.CryptoJS=e()})(Y,function(){var d=d||function(e,t){var r;if(typeof window!="undefined"&&window.crypto&&(r=window.crypto),typeof self!="undefined"&&self.crypto&&(r=self.crypto),typeof globalThis!="undefined"&&globalThis.crypto&&(r=globalThis.crypto),!r&&typeof window!="undefined"&&window.msCrypto&&(r=window.msCrypto),!r&&typeof global!="undefined"&&global.crypto&&(r=global.crypto),!r&&typeof be=="function")try{r=we()}catch{}var s=function(){if(r){if(typeof r.getRandomValues=="function")try{return r.getRandomValues(new Uint32Array(1))[0]}catch{}if(typeof r.randomBytes=="function")try{return r.randomBytes(4).readInt32LE()}catch{}}throw new Error("Native crypto module could not be used to get secure random number.")},a=Object.create||function(){function n(){}return function(u){var f;return n.prototype=u,f=new n,n.prototype=null,f}}(),c={},o=c.lib={},l=o.Base=function(){return{extend:function(n){var u=a(this);return n&&u.mixIn(n),(!u.hasOwnProperty("init")||this.init===u.init)&&(u.init=function(){u.$super.init.apply(this,arguments)}),u.init.prototype=u,u.$super=this,u},create:function(){var n=this.extend();return n.init.apply(n,arguments),n},init:function(){},mixIn:function(n){for(var u in n)n.hasOwnProperty(u)&&(this[u]=n[u]);n.hasOwnProperty("toString")&&(this.toString=n.toString)},clone:function(){return this.init.prototype.extend(this)}}}(),h=o.WordArray=l.extend({init:function(n,u){n=this.words=n||[],u!=t?this.sigBytes=u:this.sigBytes=n.length*4},toString:function(n){return(n||v).stringify(this)},concat:function(n){var u=this.words,f=n.words,S=this.sigBytes,w=n.sigBytes;if(this.clamp(),S%4)for(var b=0;b<w;b++){var U=f[b>>>2]>>>24-b%4*8&255;u[S+b>>>2]|=U<<24-(S+b)%4*8}else for(var R=0;R<w;R+=4)u[S+R>>>2]=f[R>>>2];return this.sigBytes+=w,this},clamp:function(){var n=this.words,u=this.sigBytes;n[u>>>2]&=4294967295<<32-u%4*8,n.length=e.ceil(u/4)},clone:function(){var n=l.clone.call(this);return n.words=this.words.slice(0),n},random:function(n){for(var u=[],f=0;f<n;f+=4)u.push(s());return new h.init(u,n)}}),g=c.enc={},v=g.Hex={stringify:function(n){for(var u=n.words,f=n.sigBytes,S=[],w=0;w<f;w++){var b=u[w>>>2]>>>24-w%4*8&255;S.push((b>>>4).toString(16)),S.push((b&15).toString(16))}return S.join("")},parse:function(n){for(var u=n.length,f=[],S=0;S<u;S+=2)f[S>>>3]|=parseInt(n.substr(S,2),16)<<24-S%8*4;return new h.init(f,u/2)}},_=g.Latin1={stringify:function(n){for(var u=n.words,f=n.sigBytes,S=[],w=0;w<f;w++){var b=u[w>>>2]>>>24-w%4*8&255;S.push(String.fromCharCode(b))}return S.join("")},parse:function(n){for(var u=n.length,f=[],S=0;S<u;S++)f[S>>>2]|=(n.charCodeAt(S)&255)<<24-S%4*8;return new h.init(f,u)}},p=g.Utf8={stringify:function(n){try{return decodeURIComponent(escape(_.stringify(n)))}catch{throw new Error("Malformed UTF-8 data")}},parse:function(n){return _.parse(unescape(encodeURIComponent(n)))}},m=o.BufferedBlockAlgorithm=l.extend({reset:function(){this._data=new h.init,this._nDataBytes=0},_append:function(n){typeof n=="string"&&(n=p.parse(n)),this._data.concat(n),this._nDataBytes+=n.sigBytes},_process:function(n){var u,f=this._data,S=f.words,w=f.sigBytes,b=this.blockSize,U=b*4,R=w/U;n?R=e.ceil(R):R=e.max((R|0)-this._minBufferSize,0);var C=R*b,L=e.min(C*4,w);if(C){for(var N=0;N<C;N+=b)this._doProcessBlock(S,N);u=S.splice(0,C),f.sigBytes-=L}return new h.init(u,L)},clone:function(){var n=l.clone.call(this);return n._data=this._data.clone(),n},_minBufferSize:0}),y=o.Hasher=m.extend({cfg:l.extend(),init:function(n){this.cfg=this.cfg.extend(n),this.reset()},reset:function(){m.reset.call(this),this._doReset()},update:function(n){return this._append(n),this._process(),this},finalize:function(n){n&&this._append(n);var u=this._doFinalize();return u},blockSize:512/32,_createHelper:function(n){return function(u,f){return new n.init(f).finalize(u)}},_createHmacHelper:function(n){return function(u,f){return new k.HMAC.init(n,f).finalize(u)}}}),k=c.algo={};return c}(Math);return d})});var xe=G((X,Re)=>{(function(d,e){typeof X=="object"?Re.exports=X=e(re()):typeof define=="function"&&define.amd?define(["./core"],e):e(d.CryptoJS)})(X,function(d){return function(e){var t=d,r=t.lib,s=r.WordArray,a=r.Hasher,c=t.algo,o=[],l=[];(function(){function v(y){for(var k=e.sqrt(y),n=2;n<=k;n++)if(!(y%n))return!1;return!0}function _(y){return(y-(y|0))*4294967296|0}for(var p=2,m=0;m<64;)v(p)&&(m<8&&(o[m]=_(e.pow(p,1/2))),l[m]=_(e.pow(p,1/3)),m++),p++})();var h=[],g=c.SHA256=a.extend({_doReset:function(){this._hash=new s.init(o.slice(0))},_doProcessBlock:function(v,_){for(var p=this._hash.words,m=p[0],y=p[1],k=p[2],n=p[3],u=p[4],f=p[5],S=p[6],w=p[7],b=0;b<64;b++){if(b<16)h[b]=v[_+b]|0;else{var U=h[b-15],R=(U<<25|U>>>7)^(U<<14|U>>>18)^U>>>3,C=h[b-2],L=(C<<15|C>>>17)^(C<<13|C>>>19)^C>>>10;h[b]=R+h[b-7]+L+h[b-16]}var N=u&f^~u&S,We=m&y^m&k^y&k,Fe=(m<<30|m>>>2)^(m<<19|m>>>13)^(m<<10|m>>>22),Le=(u<<26|u>>>6)^(u<<21|u>>>11)^(u<<7|u>>>25),Se=w+Le+N+l[b]+h[b],je=Fe+We;w=S,S=f,f=u,u=n+Se|0,n=k,k=y,y=m,m=Se+je|0}p[0]=p[0]+m|0,p[1]=p[1]+y|0,p[2]=p[2]+k|0,p[3]=p[3]+n|0,p[4]=p[4]+u|0,p[5]=p[5]+f|0,p[6]=p[6]+S|0,p[7]=p[7]+w|0},_doFinalize:function(){var v=this._data,_=v.words,p=this._nDataBytes*8,m=v.sigBytes*8;return _[m>>>5]|=128<<24-m%32,_[(m+64>>>9<<4)+14]=e.floor(p/4294967296),_[(m+64>>>9<<4)+15]=p,v.sigBytes=_.length*4,this._process(),this._hash},clone:function(){var v=a.clone.call(this);return v._hash=this._hash.clone(),v}});t.SHA256=a._createHelper(g),t.HmacSHA256=a._createHmacHelper(g)}(Math),d.SHA256})});var Ue=G((Z,Pe)=>{(function(d,e){typeof Z=="object"?Pe.exports=Z=e(re()):typeof define=="function"&&define.amd?define(["./core"],e):e(d.CryptoJS)})(Z,function(d){return function(){var e=d,t=e.lib,r=t.WordArray,s=e.enc,a=s.Base64={stringify:function(o){var l=o.words,h=o.sigBytes,g=this._map;o.clamp();for(var v=[],_=0;_<h;_+=3)for(var p=l[_>>>2]>>>24-_%4*8&255,m=l[_+1>>>2]>>>24-(_+1)%4*8&255,y=l[_+2>>>2]>>>24-(_+2)%4*8&255,k=p<<16|m<<8|y,n=0;n<4&&_+n*.75<h;n++)v.push(g.charAt(k>>>6*(3-n)&63));var u=g.charAt(64);if(u)for(;v.length%4;)v.push(u);return v.join("")},parse:function(o){var l=o.length,h=this._map,g=this._reverseMap;if(!g){g=this._reverseMap=[];for(var v=0;v<h.length;v++)g[h.charCodeAt(v)]=v}var _=h.charAt(64);if(_){var p=o.indexOf(_);p!==-1&&(l=p)}return c(o,l,g)},_map:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/="};function c(o,l,h){for(var g=[],v=0,_=0;_<l;_++)if(_%4){var p=h[o.charCodeAt(_-1)]<<_%4*2,m=h[o.charCodeAt(_)]>>>6-_%4*2,y=p|m;g[v>>>2]|=y<<24-v%4*8,v++}return r.create(g,v)}}(),d.enc.Base64})});var gt={};De(gt,{AccessTokenEvents:()=>K,CheckSessionIFrame:()=>D,InMemoryWebStorage:()=>pe,Log:()=>i,MetadataService:()=>J,OidcClient:()=>ee,SessionMonitor:()=>z,TokenRevocationClient:()=>Q,User:()=>O,UserManager:()=>Ne,UserManagerEvents:()=>V,Version:()=>qe,WebStorageStateStore:()=>W});var Ie=ye(xe()),Te=ye(Ue());var Qe={debug:()=>{},info:()=>{},warn:()=>{},error:()=>{}},Ce=0,Ee=1,Me=2,se=3,ne=4,A,q,i=class{static get NONE(){return Ce}static get ERROR(){return Ee}static get WARN(){return Me}static get INFO(){return se}static get DEBUG(){return ne}static reset(){q=se,A=Qe}static get level(){return q}static set level(e){if(Ce>e||e>ne)throw new Error("Invalid log level");q=e}static get logger(){return A}static set logger(e){A=e}static debug(...e){q>=ne&&A.debug(...e)}static info(...e){q>=se&&A.info(...e)}static warn(...e){q>=Me&&A.warn(...e)}static error(...e){q>=Ee&&A.error(...e)}};i.reset();var Oe="10000000-1000-4000-8000-100000000000",E=class{static _cryptoUUIDv4(){return Oe.replace(/[018]/g,e=>(+e^window.crypto.getRandomValues(new Uint8Array(1))[0]&15>>+e/4).toString(16))}static _UUIDv4(){return Oe.replace(/[018]/g,e=>(+e^Math.random()*16>>+e/4).toString(16))}static generateUUIDv4(){return(window.crypto&&Object.prototype.hasOwnProperty.call(window.crypto,"getRandomValues")?E._cryptoUUIDv4():E._UUIDv4()).replace(/-/g,"")}static generateCodeVerifier(){return E.generateUUIDv4()+E.generateUUIDv4()+E.generateUUIDv4()}static generateCodeChallenge(e){try{let t=(0,Ie.default)(e);return Te.default.stringify(t).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"")}catch(t){throw i.error(t),t}}};var I=class{constructor(e){this._name=e;this._callbacks=[]}addHandler(e){this._callbacks.push(e)}removeHandler(e){let t=this._callbacks.findIndex(r=>r===e);t>=0&&this._callbacks.splice(t,1)}raise(...e){i.debug("Event: Raising event: "+this._name);for(let t=0;t<this._callbacks.length;t++)this._callbacks[t](...e)}};var $e=5,oe={setInterval:function(d,e){return window.setInterval(d,e)},clearInterval:function(d){return window.clearInterval(d)}},P=class extends I{constructor(){super(...arguments);this._timer=oe;this._timerHandle=null;this._expiration=0;this._callback=()=>{let e=this._expiration-P.getEpochTime();i.debug("Timer.callback; "+this._name+" timer expires in:",e),this._expiration<=P.getEpochTime()&&(this.cancel(),super.raise())}}static getEpochTime(){return Math.floor(Date.now()/1e3)}init(e){e<=0&&(e=1),e=Math.floor(e);let t=P.getEpochTime()+e;if(this.expiration===t&&this._timerHandle){i.debug("Timer.init timer "+this._name+" skipping initialization since already initialized for expiration:",this.expiration);return}this.cancel(),i.debug("Timer.init timer "+this._name+" for duration:",e),this._expiration=t;let r=$e;e<r&&(r=e),this._timerHandle=this._timer.setInterval(this._callback,r*1e3)}get expiration(){return this._expiration}cancel(){this._timerHandle&&(i.debug("Timer.cancel: ",this._name),this._timer.clearInterval(this._timerHandle),this._timerHandle=null)}};var x=class{static addQueryParam(e,t,r){return e.indexOf("?")<0&&(e+="?"),e[e.length-1]!=="?"&&(e+="&"),e+=encodeURIComponent(t),e+="=",e+=encodeURIComponent(r),e}static parseUrlFragment(e,t="#"){e||(e=location.href);let r=e.lastIndexOf(t);r>=0&&(e=e.substr(r+1)),t==="?"&&(r=e.indexOf("#"),r>=0&&(e=e.substr(0,r)));let s={},a=/([^&=]+)=([^&]*)/g,c,o=0;for(;(c=a.exec(e))!==null;)if(s[decodeURIComponent(c[1])]=decodeURIComponent(c[2].replace(/\+/g," ")),o++>50)return i.error("UrlUtils.parseUrlFragment: response exceeded expected number of parameters",e),{error:"Response exceeded expected number of parameters"};return s}};var W=class{constructor({prefix:e="oidc.",store:t=localStorage}={}){this._store=t,this._prefix=e}set(e,t){return i.debug("WebStorageStateStore.set",e),e=this._prefix+e,this._store.setItem(e,t),Promise.resolve()}get(e){i.debug("WebStorageStateStore.get",e),e=this._prefix+e;let t=this._store.getItem(e);return Promise.resolve(t)}remove(e){i.debug("WebStorageStateStore.remove",e),e=this._prefix+e;let t=this._store.getItem(e);return this._store.removeItem(e),Promise.resolve(t)}getAllKeys(){i.debug("WebStorageStateStore.getAllKeys");let e=[];for(let t=0;t<this._store.length;t++){let r=this._store.key(t);r&&r.indexOf(this._prefix)===0&&e.push(r.substr(this._prefix.length))}return Promise.resolve(e)}};var Ge="code",Ye="openid",Xe="client_secret_post",Ze=60*15,et=60*5,j=class{constructor({authority:e,metadataUrl:t,metadata:r,signingKeys:s,metadataSeed:a,client_id:c,client_secret:o,response_type:l=Ge,scope:h=Ye,redirect_uri:g,post_logout_redirect_uri:v,client_authentication:_=Xe,prompt:p,display:m,max_age:y,ui_locales:k,acr_values:n,resource:u,response_mode:f,filterProtocolClaims:S=!0,staleStateAgeInSeconds:w=Ze,clockSkewInSeconds:b=et,userInfoJwtIssuer:U="OP",mergeClaims:R=!1,stateStore:C=new W,extraQueryParams:L={},extraTokenParams:N={}}){this.authority=e,this.metadataUrl=t,this.metadata=r,this.metadataSeed=a,this.signingKeys=s,this.client_id=c,this.client_secret=o,this.response_type=l,this.scope=h,this.redirect_uri=g,this.post_logout_redirect_uri=v,this.client_authentication=_,this.prompt=p,this.display=m,this.max_age=y,this.ui_locales=k,this.acr_values=n,this.resource=u,this.response_mode=f,this.filterProtocolClaims=!!S,this.staleStateAgeInSeconds=w,this.clockSkewInSeconds=b,this.userInfoJwtIssuer=U,this.mergeClaims=!!R,this.stateStore=C,this.extraQueryParams=L,this.extraTokenParams=N}};var H=class{constructor(e=[],t=null){this._contentTypes=e.slice(),this._contentTypes.push("application/json"),t&&this._contentTypes.push("application/jwt"),this._jwtHandler=t}async getJson(e,t){if(!e)throw i.error("JsonService.getJson: No url passed"),new Error("url");let r={};t&&(i.debug("JsonService.getJson: token passed, setting Authorization header"),r.Authorization="Bearer "+t);let s;try{i.debug("JsonService.getJson, url: ",e),s=await fetch(e,{method:"GET",headers:r})}catch{throw i.error("JsonService.getJson: network error"),new Error("Network Error")}if(i.debug("JsonService.getJson: HTTP response received, status",s.status),s.status===200){let a=s.headers.get("Content-Type");if(a){let c=this._contentTypes.find(o=>a.startsWith(o));if(c==="application/jwt"&&this._jwtHandler){let o=await s.text();return await this._jwtHandler(o)}if(c)try{return await s.json()}catch(o){throw i.error("JsonService.getJson: Error parsing JSON response",o instanceof Error?o.message:o),o}}throw new Error("Invalid response Content-Type: "+(a!=null?a:"undefined")+", from URL: "+e)}throw new Error(s.statusText+" ("+s.status.toString()+")")}async postForm(e,t,r){if(!e)throw i.error("JsonService.postForm: No url passed"),new Error("url");let s={"Content-Type":"application/x-www-form-urlencoded"};r!==void 0&&(s.Authorization="Basic "+btoa(r));let a=new URLSearchParams;for(let l in t){let h=t[l];h&&a.set(l,h)}let c;try{i.debug("JsonService.postForm, url: ",e),c=await fetch(e,{method:"POST",headers:s,body:a})}catch{throw i.error("JsonService.postForm: network error"),new Error("Network Error")}let o=this._contentTypes;if(i.debug("JsonService.postForm: HTTP response received, status",c.status),c.status===200){let l=c.headers.get("Content-Type");if(l&&o.find(g=>l.startsWith(g)))try{return await c.json()}catch(g){throw i.error("JsonService.postForm: Error parsing JSON response",g instanceof Error?g.message:g),g}throw new Error("Invalid response Content-Type: "+(l!=null?l:"undefined")+", from URL: "+e)}else if(c.status===400){let l=c.headers.get("Content-Type");if(l&&o.find(g=>l.startsWith(g)))try{let g=await c.json();if(g&&g.error)throw i.error("JsonService.postForm: Error from server: ",g.error),new Error(t.error);return g}catch(g){throw i.error("JsonService.postForm: Error parsing JSON response",g instanceof Error?g.message:g),g}throw new Error("Invalid response Content-Type: "+(l!=null?l:"undefined")+", from URL: "+e)}throw new Error(c.statusText+" ("+c.status.toString()+")")}};var B=class{constructor(e,t){this._settings=e,this._jsonService=new H,this._metadataService=t}async exchangeCode(e){e=Object.assign({},e),e.grant_type=e.grant_type||"authorization_code",e.client_id=e.client_id||this._settings.client_id,e.client_secret=e.client_secret||this._settings.client_secret,e.redirect_uri=e.redirect_uri||this._settings.redirect_uri;let t=this._settings.client_authentication;if(!e.client_id)throw i.error("TokenClient.exchangeCode: No client_id passed"),new Error("A client_id is required");if(!e.redirect_uri)throw i.error("TokenClient.exchangeCode: No redirect_uri passed"),new Error("A redirect_uri is required");if(!e.code)throw i.error("TokenClient.exchangeCode: No code passed"),new Error("A code is required");if(!e.code_verifier)throw i.error("TokenClient.exchangeCode: No code_verifier passed"),new Error("A code_verifier is required");let r;if(t=="client_secret_basic"){if(!e.client_secret)throw i.error("TokenClient.exchangeCode: No client_secret passed"),new Error("A client_secret is required");r=e.client_id+":"+e.client_secret,delete e.client_id,delete e.client_secret}let s=await this._metadataService.getTokenEndpoint(!1);i.debug("TokenClient.exchangeCode: Received token endpoint");let a=await this._jsonService.postForm(s,e,r);return i.debug("TokenClient.exchangeCode: response received"),a}async exchangeRefreshToken(e){e=Object.assign({},e),e.grant_type=e.grant_type||"refresh_token",e.client_id=e.client_id||this._settings.client_id,e.client_secret=e.client_secret||this._settings.client_secret;let t=this._settings.client_authentication;if(!e.refresh_token)throw i.error("TokenClient.exchangeRefreshToken: No refresh_token passed"),new Error("A refresh_token is required");if(!e.client_id)throw i.error("TokenClient.exchangeRefreshToken: No client_id passed"),new Error("A client_id is required");let r;if(t=="client_secret_basic"){if(!e.client_secret)throw i.error("TokenClient.exchangeCode: No client_secret passed"),new Error("A client_secret is required");r=e.client_id+":"+e.client_secret,delete e.client_id,delete e.client_secret}let s=await this._metadataService.getTokenEndpoint(!1);i.debug("TokenClient.exchangeRefreshToken: Received token endpoint");let a=await this._jsonService.postForm(s,e,r);return i.debug("TokenClient.exchangeRefreshToken: response received"),a}};var T=class extends Error{constructor(e){if(!e.error)throw i.error("No error passed to ErrorResponse"),new Error("error");super(e.error_description||e.error);this.name="ErrorResponse",this.error=e.error,this.error_description=e.error_description,this.error_uri=e.error_uri,this.state=e.state,this.session_state=e.session_state}};var tt=["at_hash","iat","nbf","exp","aud","iss","c_hash"],ae=class{constructor(e,t){this._settings=e,this._metadataService=t,this._tokenClient=new B(this._settings,t)}async validateSigninResponse(e,t){return i.debug("ResponseValidator.validateSigninResponse"),t=this._processSigninParams(e,t),i.debug("ResponseValidator.validateSigninResponse: state processed"),t=await this._validateTokens(e,t),i.debug("ResponseValidator.validateSigninResponse: tokens validated"),t=await this._processClaims(e,t),i.debug("ResponseValidator.validateSigninResponse: claims processed"),t}validateSignoutResponse(e,t){if(e.id!==t.state)throw i.error("ResponseValidator.validateSignoutResponse: State does not match"),new Error("State does not match");if(i.debug("ResponseValidator.validateSignoutResponse: state validated"),t.state=e.data,t.error)throw i.warn("ResponseValidator.validateSignoutResponse: Response was error",t.error),new T(t);return t}_processSigninParams(e,t){if(e.id!==t.state)throw i.error("ResponseValidator._processSigninParams: State does not match"),new Error("State does not match");if(!e.client_id)throw i.error("ResponseValidator._processSigninParams: No client_id on state"),new Error("No client_id on state");if(!e.authority)throw i.error("ResponseValidator._processSigninParams: No authority on state"),new Error("No authority on state");if(this._settings.authority!==e.authority)throw i.error("ResponseValidator._processSigninParams: authority mismatch on settings vs. signin state"),new Error("authority mismatch on settings vs. signin state");if(this._settings.client_id&&this._settings.client_id!==e.client_id)throw i.error("ResponseValidator._processSigninParams: client_id mismatch on settings vs. signin state"),new Error("client_id mismatch on settings vs. signin state");if(i.debug("ResponseValidator._processSigninParams: state validated"),t.state=e.data,t.error)throw i.warn("ResponseValidator._processSigninParams: Response was error",t.error),new T(t);if(e.code_verifier&&!t.code)throw i.error("ResponseValidator._processSigninParams: Expecting code in response"),new Error("No code in response");if(!e.code_verifier&&t.code)throw i.error("ResponseValidator._processSigninParams: Not expecting code in response"),new Error("Unexpected code in response");return t.scope||(t.scope=e.scope),t}async _processClaims(e,t){return t.isOpenIdConnect?(i.debug("ResponseValidator._processClaims: response is OIDC, processing claims"),t.profile=this._filterProtocolClaims(t.profile)):i.debug("ResponseValidator._processClaims: response is not OIDC, not processing claims"),t}_filterProtocolClaims(e){i.debug("ResponseValidator._filterProtocolClaims, incoming claims:",e);let t=Object.assign({},e);return this._settings.filterProtocolClaims?(tt.forEach(r=>{delete t[r]}),i.debug("ResponseValidator._filterProtocolClaims: protocol claims filtered",t)):i.debug("ResponseValidator._filterProtocolClaims: protocol claims not filtered"),t}async _validateTokens(e,t){return t.code?(i.debug("ResponseValidator._validateTokens: Validating code"),this._processCode(e,t)):(i.debug("ResponseValidator._validateTokens: No code to process"),t)}async _processCode(e,t){let r={client_id:e.client_id,client_secret:e.client_secret,code:t.code,redirect_uri:e.redirect_uri,code_verifier:e.code_verifier||""};e.extraTokenParams&&typeof e.extraTokenParams=="object"&&Object.assign(r,e.extraTokenParams);let s=await this._tokenClient.exchangeCode(r);return t.error=s.error||t.error,t.error_description=s.error_description||t.error_description,t.error_uri=s.error_uri||t.error_uri,t.session_state=s.session_state||t.session_state,t.access_token=s.access_token||t.access_token,t.token_type=s.token_type||t.token_type,t.scope=s.scope||t.scope,t.expires_in=parseInt(s.expires_in)||t.expires_in,i.debug("ResponseValidator._processCode: token response successful, returning response"),t}};var it=".well-known/openid-configuration",J=class{constructor(e){this._settings=e,this._jsonService=new H(["application/jwk-set+json"]),this._metadataUrl=null,this._settings.metadataUrl?this._metadataUrl=this._settings.metadataUrl:this._settings.authority&&(this._metadataUrl=this._settings.authority,this._metadataUrl[this._metadataUrl.length-1]!=="/"&&(this._metadataUrl+="/"),this._metadataUrl+=it),this._signingKeys=null,this._settings.signingKeys&&(i.debug("MetadataService.ctor: Using signingKeys from settings"),this._signingKeys=this._settings.signingKeys),this._metadata=null,this._settings.metadata&&(i.debug("MetadataService.ctor: Using metadata from settings"),this._metadata=this._settings.metadata)}resetSigningKeys(){this._signingKeys=null}async getMetadata(){if(this._metadata)return i.debug("MetadataService.getMetadata: Returning metadata from cache"),this._metadata;if(!this._metadataUrl)throw i.error("MetadataService.getMetadata: No authority or metadataUrl configured on settings"),new Error("No authority or metadataUrl configured on settings");i.debug("MetadataService.getMetadata: getting metadata from",this._metadataUrl);let e=await this._jsonService.getJson(this._metadataUrl);i.debug("MetadataService.getMetadata: json received");let t=this._settings.metadataSeed||{};return this._metadata=Object.assign({},t,e),this._metadata}getIssuer(){return this._getMetadataProperty("issuer")}getAuthorizationEndpoint(){return this._getMetadataProperty("authorization_endpoint")}getUserInfoEndpoint(){return this._getMetadataProperty("userinfo_endpoint")}getTokenEndpoint(e=!0){return this._getMetadataProperty("token_endpoint",e)}getCheckSessionIframe(){return this._getMetadataProperty("check_session_iframe",!0)}getEndSessionEndpoint(){return this._getMetadataProperty("end_session_endpoint",!0)}getRevocationEndpoint(){return this._getMetadataProperty("revocation_endpoint",!0)}getKeysEndpoint(e=!0){return this._getMetadataProperty("jwks_uri",e)}async _getMetadataProperty(e,t=!1){i.debug("MetadataService.getMetadataProperty for: "+e);let r=await this.getMetadata();if(i.debug("MetadataService.getMetadataProperty: metadata recieved"),r[e]===void 0){if(t===!0){i.warn("MetadataService.getMetadataProperty: Metadata does not contain optional property "+e);return}throw i.error("MetadataService.getMetadataProperty: Metadata does not contain property "+e),new Error("Metadata does not contain property "+e)}return r[e]}async getSigningKeys(){if(this._signingKeys)return i.debug("MetadataService.getSigningKeys: Returning signingKeys from cache"),this._signingKeys;let e=await this.getKeysEndpoint(!1);i.debug("MetadataService.getSigningKeys: jwks_uri received",e);let t=await this._jsonService.getJson(e);if(i.debug("MetadataService.getSigningKeys: key set received",t),!t.keys)throw i.error("MetadataService.getSigningKeys: Missing keys on keyset"),new Error("Missing keys on keyset");return this._signingKeys=t.keys,this._signingKeys}};var M=class{constructor(e){this.id=e.id||E.generateUUIDv4(),this.data=e.data,e.created&&e.created>0?this.created=e.created:this.created=P.getEpochTime(),this.request_type=e.request_type}toStorageString(){return i.debug("State.toStorageString"),JSON.stringify({id:this.id,data:this.data,created:this.created,request_type:this.request_type})}static fromStorageString(e){return i.debug("State.fromStorageString"),new M(JSON.parse(e))}static async clearStaleState(e,t){let r=P.getEpochTime()-t,s=await e.getAllKeys();i.debug("State.clearStaleState: got keys",s);for(let a=0;a<s.length;a++){let c=s[a],o=await e.get(c),l=!1;if(o)try{let h=M.fromStorageString(o);i.debug("State.clearStaleState: got item from key: ",c,h.created),h.created<=r&&(l=!0)}catch(h){i.error("State.clearStaleState: Error parsing state for key",c,h instanceof Error?h.message:h),l=!0}else i.debug("State.clearStaleState: no item in storage for key: ",c),l=!0;l&&(i.debug("State.clearStaleState: removed item for key: ",c),e.remove(c))}}};var F=class extends M{constructor(e){super(e);e.code_verifier===!0?this.code_verifier=E.generateCodeVerifier():e.code_verifier&&(this.code_verifier=e.code_verifier),this.code_verifier&&(this.code_challenge=E.generateCodeChallenge(this.code_verifier)),this.authority=e.authority,this.client_id=e.client_id,this.redirect_uri=e.redirect_uri,this.scope=e.scope,this.client_secret=e.client_secret,this.extraTokenParams=e.extraTokenParams,this.response_mode=e.response_mode,this.skipUserInfo=e.skipUserInfo}toStorageString(){return i.debug("SigninState.toStorageString"),JSON.stringify({id:this.id,data:this.data,created:this.created,request_type:this.request_type,code_verifier:this.code_verifier,authority:this.authority,client_id:this.client_id,redirect_uri:this.redirect_uri,scope:this.scope,client_secret:this.client_secret,extraTokenParams:this.extraTokenParams,response_mode:this.response_mode,skipUserInfo:this.skipUserInfo})}static fromStorageString(e){i.debug("SigninState.fromStorageString");let t=JSON.parse(e);return new F(t)}};var ce=class{constructor({url:e,authority:t,client_id:r,redirect_uri:s,response_type:a,scope:c,state_data:o,prompt:l,display:h,max_age:g,ui_locales:v,login_hint:_,acr_values:p,resource:m,response_mode:y,request:k,request_uri:n,extraQueryParams:u,request_type:f,client_secret:S,extraTokenParams:w,skipUserInfo:b}){if(!e)throw i.error("SigninRequest.ctor: No url passed"),new Error("url");if(!r)throw i.error("SigninRequest.ctor: No client_id passed"),new Error("client_id");if(!s)throw i.error("SigninRequest.ctor: No redirect_uri passed"),new Error("redirect_uri");if(!a)throw i.error("SigninRequest.ctor: No response_type passed"),new Error("response_type");if(!c)throw i.error("SigninRequest.ctor: No scope passed"),new Error("scope");if(!t)throw i.error("SigninRequest.ctor: No authority passed"),new Error("authority");y||(y="query"),this.state=new F({data:o,request_type:f,code_verifier:!0,client_id:r,authority:t,redirect_uri:s,response_mode:y,client_secret:S,scope:c,extraTokenParams:w,skipUserInfo:b}),e=x.addQueryParam(e,"client_id",r),e=x.addQueryParam(e,"redirect_uri",s),e=x.addQueryParam(e,"response_type",a),e=x.addQueryParam(e,"scope",c),e=x.addQueryParam(e,"state",this.state.id),this.state.code_challenge&&(e=x.addQueryParam(e,"code_challenge",this.state.code_challenge),e=x.addQueryParam(e,"code_challenge_method","S256"));let U={prompt:l,display:h,max_age:g,ui_locales:v,login_hint:_,acr_values:p,resource:m,request:k,request_uri:n,response_mode:y};for(let R in U)U[R]&&(e=x.addQueryParam(e,R,U[R]));for(let R in u)e=x.addQueryParam(e,R,u[R]);this.url=e}};var rt="openid",de=class{constructor(e,t="#"){let r=x.parseUrlFragment(e,t);this.error=r.error,this.error_description=r.error_description,this.error_uri=r.error_uri,this.code=r.code,this.state=r.state,this.session_state=r.session_state,this.access_token=r.access_token,this.token_type=r.token_type,this.scope=r.scope,this.expires_in=parseInt(r.expires_in),this.profile={}}get expires_in(){if(this.expires_at){let e=P.getEpochTime();return this.expires_at-e}}set expires_in(e){if(e&&e>0){let t=Math.floor(e),r=P.getEpochTime();this.expires_at=r+t}}get expired(){let e=this.expires_in;if(e!==void 0)return e<=0}get scopes(){return(this.scope||"").split(" ")}get isOpenIdConnect(){return this.scopes.indexOf(rt)>=0}};var ue=class{constructor({url:e,state_data:t,post_logout_redirect_uri:r,extraQueryParams:s,request_type:a}){if(!e)throw i.error("SignoutRequest.ctor: No url passed"),new Error("url");r&&(e=x.addQueryParam(e,"post_logout_redirect_uri",r),t&&(this.state=new M({data:t,request_type:a}),e=x.addQueryParam(e,"state",this.state.id)));for(let c in s)e=x.addQueryParam(e,c,s[c]);this.url=e}};var le=class{constructor(e){let t=x.parseUrlFragment(e,"?");this.error=t.error,this.error_description=t.error_description,this.error_uri=t.error_uri,this.state=t.state}};var ee=class{constructor(e){this.settings=new j(e),this.metadataService=new J(this.settings),this._validator=new ae(this.settings,this.metadataService)}async createSigninRequest({response_type:e,scope:t,redirect_uri:r,state:s,prompt:a,display:c,max_age:o,ui_locales:l,login_hint:h,acr_values:g,resource:v,request:_,request_uri:p,response_mode:m,extraQueryParams:y,extraTokenParams:k,request_type:n,skipUserInfo:u}){if(i.debug("OidcClient.createSigninRequest"),e=e||this.settings.response_type,t=t||this.settings.scope,r=r||this.settings.redirect_uri,a=a||this.settings.prompt,c=c||this.settings.display,o=o||this.settings.max_age,l=l||this.settings.ui_locales,g=g||this.settings.acr_values,v=v||this.settings.resource,m=m||this.settings.response_mode,y=y||this.settings.extraQueryParams,k=k||this.settings.extraTokenParams,e!=="code")throw new Error("Only the Authorization Code flow (with PKCE) is supported");let f=await this.metadataService.getAuthorizationEndpoint();i.debug("OidcClient.createSigninRequest: Received authorization endpoint",f);let S=new ce({url:f,authority:this.settings.authority,client_id:this.settings.client_id,redirect_uri:r,response_type:e,scope:t,state_data:s,prompt:a,display:c,max_age:o,ui_locales:l,login_hint:h,acr_values:g,resource:v,request:_,request_uri:p,extraQueryParams:y,extraTokenParams:k,request_type:n,response_mode:m,client_secret:this.settings.client_secret,skipUserInfo:u}),w=S.state;return await this.settings.stateStore.set(w.id,w.toStorageString()),S}async readSigninResponseState(e,t=!1){i.debug("OidcClient.readSigninResponseState");let s=this.settings.response_mode==="query"||!this.settings.response_mode&&this.settings.response_type==="code"?"?":"#",a=new de(e,s);if(!a.state)throw i.error("OidcClient.readSigninResponseState: No state in response"),new Error("No state in response");let c=this.settings.stateStore,l=await(t?c.remove.bind(c):c.get.bind(c))(a.state);if(!l)throw i.error("OidcClient.readSigninResponseState: No matching state found in storage"),new Error("No matching state found in storage");return{state:F.fromStorageString(l),response:a}}async processSigninResponse(e){i.debug("OidcClient.processSigninResponse");let{state:t,response:r}=await this.readSigninResponseState(e,!0);return i.debug("OidcClient.processSigninResponse: Received state from storage; validating response"),this._validator.validateSigninResponse(t,r)}async createSignoutRequest({state:e,post_logout_redirect_uri:t,extraQueryParams:r,request_type:s}={}){i.debug("OidcClient.createSignoutRequest"),t=t||this.settings.post_logout_redirect_uri,r=r||this.settings.extraQueryParams;let a=await this.metadataService.getEndSessionEndpoint();if(!a)throw i.error("OidcClient.createSignoutRequest: No end session endpoint url returned"),new Error("no end session endpoint");i.debug("OidcClient.createSignoutRequest: Received end session endpoint",a);let c=new ue({url:a,post_logout_redirect_uri:t,state_data:e,extraQueryParams:r,request_type:s}),o=c.state;return o&&(i.debug("OidcClient.createSignoutRequest: Signout request has state to persist"),await this.settings.stateStore.set(o.id,o.toStorageString())),c}async readSignoutResponseState(e,t=!1){i.debug("OidcClient.readSignoutResponseState");let r=new le(e);if(!r.state){if(i.debug("OidcClient.readSignoutResponseState: No state in response"),r.error)throw i.warn("OidcClient.readSignoutResponseState: Response was error: ",r.error),new T(r);return{state:void 0,response:r}}let s=r.state,a=this.settings.stateStore,o=await(t?a.remove.bind(a):a.get.bind(a))(s);if(!o)throw i.error("OidcClient.readSignoutResponseState: No matching state found in storage"),new Error("No matching state found in storage");return{state:M.fromStorageString(o),response:r}}async processSignoutResponse(e){i.debug("OidcClient.processSignoutResponse");let{state:t,response:r}=await this.readSignoutResponseState(e,!0);return t?(i.debug("OidcClient.processSignoutResponse: Received state from storage; validating response"),this._validator.validateSignoutResponse(t,r)):(i.debug("OidcClient.processSignoutResponse: No state from storage; skipping validating response"),r)}clearStaleState(){return i.debug("OidcClient.clearStaleState"),M.clearStaleState(this.settings.stateStore,this.settings.staleStateAgeInSeconds)}};var pe=class{constructor(){this._data={}}clear(){i.debug("InMemoryWebStorage.clear"),this._data={}}getItem(e){return i.debug("InMemoryWebStorage.getItem",e),this._data[e]}setItem(e,t){i.debug("InMemoryWebStorage.setItem",e),this._data[e]=t}removeItem(e){i.debug("InMemoryWebStorage.removeItem",e),delete this._data[e]}get length(){return Object.getOwnPropertyNames(this._data).length}key(e){return Object.getOwnPropertyNames(this._data)[e]}};var st=10,te=class{constructor({silentRequestTimeoutInSeconds:e=st}){this._promise=new Promise((e,t)=>{this._resolve=e,this._reject=t});this._timer=null;this._timeout=()=>{i.debug("IFrameWindow.timeout"),this._error("Frame window timed out")};this._message=e=>{i.debug("IFrameWindow.message");let t=location.protocol+"//"+location.host;if(this._timer&&this._frame&&e.origin===t&&e.source===this._frame.contentWindow&&typeof e.data=="string"&&(e.data.startsWith("http://")||e.data.startsWith("https://"))){let r=e.data;r?this._success({url:r}):this._error("Invalid response from frame")}};this._timeoutInSeconds=e,window.addEventListener("message",this._message,!1),this._frame=window.document.createElement("iframe"),this._frame.style.visibility="hidden",this._frame.style.position="fixed",this._frame.style.left="-1000px",this._frame.style.top="0",this._frame.width="0",this._frame.height="0"}async navigate(e){return!e||!e.url?this._error("No url provided"):this._frame?(i.debug("IFrameWindow.navigate: Using timeout of:",this._timeoutInSeconds),this._timer=window.setTimeout(this._timeout,this._timeoutInSeconds*1e3),this._frame.src=e.url,i.debug("IFrameWindow.navigate: APPEND AFTER SET SRC "),window.document.body.appendChild(this._frame)):this._error("No _frame, already closed"),await this._promise}_success(e){this._cleanup(),i.debug("IFrameWindow: Successful response from frame window"),this._resolve(e)}_error(e){this._cleanup(),i.error(e),this._reject(new Error(e))}close(){this._cleanup()}_cleanup(){i.debug("IFrameWindow: cleanup"),this._timer!=null&&window.clearTimeout(this._timer),this._frame&&(window.removeEventListener("message",this._message,!1),window.document.body.removeChild(this._frame)),this._timer=null,this._frame=null}static notifyParent(e){i.debug("IFrameWindow.notifyParent"),e=e||window.location.href,e&&(i.debug("IFrameWindow.notifyParent: posting url message to parent"),window.parent.postMessage(e,location.protocol+"//"+location.host))}};var ge=class{constructor(e){this._settings=e}async prepare({silentRequestTimeoutInSeconds:e=this._settings.silentRequestTimeoutInSeconds}){return new te({silentRequestTimeoutInSeconds:e})}async callback(e){i.debug("IFrameNavigator.callback"),te.notifyParent(e)}};var nt=500,ot="location=no,toolbar=no,width=500,height=500,left=100,top=100;",at="_blank",ie=class{constructor({popupWindowTarget:e=at,popupWindowFeatures:t=ot}){this._promise=new Promise((e,t)=>{this._resolve=e,this._reject=t});this._checkForPopupClosedTimer=null;this._messageReceived=e=>{if(e.origin!==window.location.origin){i.warn("PopupWindow:_messageReceived: Message not coming from same origin: "+e.origin);return}let{data:t,url:r,keepOpen:s}=JSON.parse(e.data);if(t.state){let a=window["popupCallback_"+t.state];a?(i.debug("PopupWindow._messageReceived: passing url message to opener"),a(r,s)):i.warn("PopupWindow._messageReceived: no matching callback found on opener")}else i.warn("PopupWindow._messageReceived: no state found in response url")};this._checkForPopupClosed=()=>{(!this._popup||this._popup.closed)&&this._error("Popup window closed")};this._callback=(e,t)=>{this._cleanup(t),e?(i.debug("PopupWindow.callback success"),this._success({url:e})):(i.debug("PopupWindow.callback: Invalid response from popup"),this._error("Invalid response from popup"))};this._popup=window.open("",e,t),this._popup&&(i.debug("PopupWindow.ctor: popup successfully created"),this._checkForPopupClosedTimer=window.setInterval(this._checkForPopupClosed,nt))}async navigate(e){return this._popup?!e||!e.url?(this._error("PopupWindow.navigate: no url provided"),this._error("No url provided")):(i.debug("PopupWindow.navigate: Setting URL in popup"),this._id=e.id,this._id&&(window["popupCallback_"+this._id]=this._callback),this._popup.focus(),this._popup.window.location.replace(e.url),window.addEventListener("message",this._messageReceived,!1)):this._error("PopupWindow.navigate: Error opening popup window"),await this._promise}_success(e){i.debug("PopupWindow.callback: Successful response from popup window"),this._cleanup(),this._resolve(e)}_error(e){i.error("PopupWindow.error: ",e),this._cleanup(),this._reject(new Error(e))}close(){this._cleanup(!1)}_cleanup(e){i.debug("PopupWindow.cleanup"),this._checkForPopupClosedTimer&&(window.clearInterval(this._checkForPopupClosedTimer),this._checkForPopupClosedTimer=null),window.removeEventListener("message",this._messageReceived),this._id&&delete window["popupCallback_"+this._id],this._id=void 0,this._popup&&!e&&this._popup.close(),this._popup=null}static notifyOpener(e,t,r){var s;if(window.opener){if(e=e||window.location.href,e){let a=x.parseUrlFragment(e,r);(s=window.opener)==null||s.postMessage(JSON.stringify({data:a,url:e,keepOpen:t}),window.location.origin)}}else i.warn("PopupWindow.notifyOpener: no window.opener. Can't complete notification.")}};var he=class{constructor(e){this._settings=e}async prepare({popupWindowFeatures:e=this._settings.popupWindowFeatures,popupWindowTarget:t=this._settings.popupWindowTarget}){return new ie({popupWindowFeatures:e,popupWindowTarget:t})}async callback(e,t,r){i.debug("PopupNavigator.callback"),ie.notifyOpener(e,t,r)}};var _e=class{constructor(e){this._settings=e}async prepare({redirectMethod:e}){return this._redirectMethod=e!=null?e:this._settings.redirectMethod,this}async navigate(e){if(!e||!e.url)throw i.error("RedirectNavigator.navigate: No url provided"),new Error("No url provided");return window.location[this._redirectMethod||"assign"](e.url),{url:window.location.href}}close(){i.warn("RedirectNavigator cannot close the current window")}};var ct=60,dt=2,me=class extends j{constructor(e){let{popup_redirect_uri:t,popup_post_logout_redirect_uri:r,popupWindowFeatures:s,popupWindowTarget:a,redirectMethod:c="assign",silent_redirect_uri:o,silentRequestTimeoutInSeconds:l,automaticSilentRenew:h=!0,validateSubOnSilentRenew:g=!0,monitorSession:v=!1,monitorAnonymousSession:_=!1,checkSessionIntervalInSeconds:p=dt,query_status_response_type:m,stopCheckSessionOnError:y=!0,revokeAccessTokenOnSignout:k=!1,accessTokenExpiringNotificationTimeInSeconds:n=ct,userStore:u=new W({store:sessionStorage})}=e;super(e);this.popup_redirect_uri=t,this.popup_post_logout_redirect_uri=r,this.popupWindowFeatures=s,this.popupWindowTarget=a,this.redirectMethod=c,this.silent_redirect_uri=o,this.silentRequestTimeoutInSeconds=l,this.automaticSilentRenew=h,this.validateSubOnSilentRenew=g,this.monitorSession=v,this.monitorAnonymousSession=_,this.checkSessionIntervalInSeconds=p,this.stopCheckSessionOnError=y,m?this.query_status_response_type=m:this.query_status_response_type="code",this.revokeAccessTokenOnSignout=k,this.accessTokenExpiringNotificationTimeInSeconds=n,this.userStore=u}};var O=class{constructor(e){this.session_state=e.session_state,this.access_token=e.access_token,this.refresh_token=e.refresh_token,this.token_type=e.token_type,this.scope=e.scope,this.profile=e.profile,this.expires_at=e.expires_at}get expires_in(){if(this.expires_at){let e=P.getEpochTime();return this.expires_at-e}}set expires_in(e){if(e&&e>0){let t=Math.floor(e),r=P.getEpochTime();this.expires_at=r+t}}get expired(){let e=this.expires_in;if(e!==void 0)return e<=0}get scopes(){return(this.scope||"").split(" ")}toStorageString(){return i.debug("User.toStorageString"),JSON.stringify({session_state:this.session_state,access_token:this.access_token,refresh_token:this.refresh_token,token_type:this.token_type,scope:this.scope,profile:this.profile,expires_at:this.expires_at})}static fromStorageString(e){return i.debug("User.fromStorageString"),new O(JSON.parse(e))}};var K=class{constructor({expiringNotificationTimeInSeconds:e}){this._expiringNotificationTimeInSeconds=e,this._expiringTimer=new P("Access token expiring"),this._expiredTimer=new P("Access token expired")}load(e){if(e.access_token&&e.expires_in!==void 0){let t=e.expires_in;if(i.debug("AccessTokenEvents.load: access token present, remaining duration:",t),t>0){let s=t-this._expiringNotificationTimeInSeconds;s<=0&&(s=1),i.debug("AccessTokenEvents.load: registering expiring timer in:",s),this._expiringTimer.init(s)}else i.debug("AccessTokenEvents.load: canceling existing expiring timer becase we're past expiration."),this._expiringTimer.cancel();let r=t+1;i.debug("AccessTokenEvents.load: registering expired timer in:",r),this._expiredTimer.init(r)}else this._expiringTimer.cancel(),this._expiredTimer.cancel()}unload(){i.debug("AccessTokenEvents.unload: canceling existing access token timers"),this._expiringTimer.cancel(),this._expiredTimer.cancel()}addAccessTokenExpiring(e){this._expiringTimer.addHandler(e)}removeAccessTokenExpiring(e){this._expiringTimer.removeHandler(e)}addAccessTokenExpired(e){this._expiredTimer.addHandler(e)}removeAccessTokenExpired(e){this._expiredTimer.removeHandler(e)}};var V=class extends K{constructor(e){super({expiringNotificationTimeInSeconds:e.accessTokenExpiringNotificationTimeInSeconds});this._userLoaded=new I("User loaded"),this._userUnloaded=new I("User unloaded"),this._silentRenewError=new I("Silent renew error"),this._userSignedIn=new I("User signed in"),this._userSignedOut=new I("User signed out"),this._userSessionChanged=new I("User session changed")}load(e,t=!0){i.debug("UserManagerEvents.load"),super.load(e),t&&this._userLoaded.raise(e)}unload(){i.debug("UserManagerEvents.unload"),super.unload(),this._userUnloaded.raise()}addUserLoaded(e){this._userLoaded.addHandler(e)}removeUserLoaded(e){this._userLoaded.removeHandler(e)}addUserUnloaded(e){this._userUnloaded.addHandler(e)}removeUserUnloaded(e){this._userUnloaded.removeHandler(e)}addSilentRenewError(e){this._silentRenewError.addHandler(e)}removeSilentRenewError(e){this._silentRenewError.removeHandler(e)}_raiseSilentRenewError(e){i.debug("UserManagerEvents._raiseSilentRenewError",e.message),this._silentRenewError.raise(e)}addUserSignedIn(e){this._userSignedIn.addHandler(e)}removeUserSignedIn(e){this._userSignedIn.removeHandler(e)}_raiseUserSignedIn(){i.debug("UserManagerEvents._raiseUserSignedIn"),this._userSignedIn.raise()}addUserSignedOut(e){this._userSignedOut.addHandler(e)}removeUserSignedOut(e){this._userSignedOut.removeHandler(e)}_raiseUserSignedOut(){i.debug("UserManagerEvents._raiseUserSignedOut"),this._userSignedOut.raise()}addUserSessionChanged(e){this._userSessionChanged.addHandler(e)}removeUserSessionChanged(e){this._userSessionChanged.removeHandler(e)}_raiseUserSessionChanged(){i.debug("UserManagerEvents._raiseUserSessionChanged"),this._userSessionChanged.raise()}};var fe=class{constructor(e){this._userManager=e;this._isStarted=!1;this._tokenExpiring=()=>{this._userManager.signinSilent().then(()=>{i.debug("SilentRenewService._tokenExpiring: Silent token renewal successful")}).catch(e=>{i.error("SilentRenewService._tokenExpiring: Error from signinSilent:",e instanceof Error?e.message:e),this._userManager.events._raiseSilentRenewError(e instanceof Error?e:new Error("Silent renew failed"))})}}async start(){if(!this._isStarted){this._isStarted=!0,this._userManager.events.addAccessTokenExpiring(this._tokenExpiring);try{await this._userManager.getUser()}catch(e){i.error("SilentRenewService.start: Error from getUser:",e instanceof Error?e.message:e)}}}stop(){this._isStarted&&(this._userManager.events.removeAccessTokenExpiring(this._tokenExpiring),this._isStarted=!1)}};var D=class{constructor(e,t,r,s,a){this._callback=e;this._client_id=t;this._intervalInSeconds=s;this._stopOnError=a;this._timer=null;this._session_state=null;this._message=e=>{e.origin===this._frame_origin&&e.source===this._frame.contentWindow&&(e.data==="error"?(i.error("CheckSessionIFrame: error message from check session op iframe"),this._stopOnError&&this.stop()):e.data==="changed"?(i.debug("CheckSessionIFrame: changed message from check session op iframe"),this.stop(),this._callback()):i.debug("CheckSessionIFrame: "+e.data+" message from check session op iframe"))};let c=r.indexOf("/",r.indexOf("//")+2);this._frame_origin=r.substr(0,c),this._frame=window.document.createElement("iframe"),this._frame.style.visibility="hidden",this._frame.style.position="fixed",this._frame.style.left="-1000px",this._frame.style.top="0",this._frame.width="0",this._frame.height="0",this._frame.src=r}load(){return new Promise(e=>{this._frame.onload=()=>{e()},window.document.body.appendChild(this._frame),window.addEventListener("message",this._message,!1)})}start(e){if(this._session_state===e)return;i.debug("CheckSessionIFrame.start"),this.stop(),this._session_state=e;let t=()=>{!this._frame.contentWindow||!this._session_state||this._frame.contentWindow.postMessage(this._client_id+" "+this._session_state,this._frame_origin)};t(),this._timer=window.setInterval(t,this._intervalInSeconds*1e3)}stop(){this._session_state=null,this._timer&&(i.debug("CheckSessionIFrame.stop"),window.clearInterval(this._timer),this._timer=null)}};var z=class{constructor(e){this._start=async e=>{let t=e.session_state;if(!!t){if(e.profile?(this._sub=e.profile.sub,this._sid=e.profile.sid,i.debug("SessionMonitor._start: session_state:",t,", sub:",this._sub)):(this._sub=void 0,this._sid=void 0,i.debug("SessionMonitor._start: session_state:",t,", anonymous user")),this._checkSessionIFrame){this._checkSessionIFrame.start(t);return}try{let r=await this._userManager.metadataService.getCheckSessionIframe();if(r){i.debug("SessionMonitor._start: Initializing check session iframe");let s=this._userManager.settings.client_id,a=this._userManager.settings.checkSessionIntervalInSeconds,c=this._userManager.settings.stopCheckSessionOnError,o=new D(this._callback,s,r,a,c);await o.load(),this._checkSessionIFrame=o,o.start(t)}else i.warn("SessionMonitor._start: No check session iframe found in the metadata")}catch(r){i.error("SessionMonitor._start: Error from getCheckSessionIframe:",r instanceof Error?r.message:r)}}};this._stop=()=>{if(this._sub=void 0,this._sid=void 0,this._checkSessionIFrame&&(i.debug("SessionMonitor._stop"),this._checkSessionIFrame.stop()),this._userManager.settings.monitorAnonymousSession){let e=this._timer.setInterval(async()=>{this._timer.clearInterval(e);try{let t=await this._userManager.querySessionStatus();if(t){let r={session_state:t.session_state,profile:t.sub&&t.sid?{sub:t.sub,sid:t.sid}:null};this._start(r)}}catch(t){i.error("SessionMonitor: error from querySessionStatus:",t instanceof Error?t.message:t)}},1e3)}};this._callback=async()=>{try{let e=await this._userManager.querySessionStatus(),t=!0;e&&this._checkSessionIFrame?e.sub===this._sub?(t=!1,this._checkSessionIFrame.start(e.session_state),e.sid===this._sid?i.debug("SessionMonitor._callback: Same sub still logged in at OP, restarting check session iframe; session_state:",e.session_state):(i.debug("SessionMonitor._callback: Same sub still logged in at OP, session state has changed, restarting check session iframe; session_state:",e.session_state),this._userManager.events._raiseUserSessionChanged())):i.debug("SessionMonitor._callback: Different subject signed into OP:",e.sub):i.debug("SessionMonitor._callback: Subject no longer signed into OP"),t&&(this._sub?(i.debug("SessionMonitor._callback: SessionMonitor._callback; raising signed out event"),this._userManager.events._raiseUserSignedOut()):(i.debug("SessionMonitor._callback: SessionMonitor._callback; raising signed in event"),this._userManager.events._raiseUserSignedIn()))}catch(e){this._sub&&(i.debug("SessionMonitor._callback: Error calling queryCurrentSigninSession; raising signed out event",e instanceof Error?e.message:e),this._userManager.events._raiseUserSignedOut())}};if(!e)throw i.error("SessionMonitor.ctor: No user manager passed to SessionMonitor"),new Error("userManager");this._userManager=e,this._timer=oe,this._userManager.events.addUserLoaded(this._start),this._userManager.events.addUserUnloaded(this._stop),Promise.resolve(this._init()).catch(t=>{i.error("SessionMonitor ctor: error:",t.message)})}async _init(){let e=await this._userManager.getUser();if(e)this._start(e);else if(this._userManager.settings.monitorAnonymousSession){let t=await this._userManager.querySessionStatus();if(t){let r={session_state:t.session_state,profile:t.sub&&t.sid?{sub:t.sub,sid:t.sid}:null};this._start(r)}}}};var ut="access_token",lt="refresh_token",Q=class{constructor(e,t){this._settings=e,this._metadataService=t}async revoke(e,t,r="access_token"){if(!e)throw i.error("TokenRevocationClient.revoke: No token provided"),new Error("No token provided.");if(r!==ut&&r!=lt)throw i.error("TokenRevocationClient.revoke: Invalid token type"),new Error("Invalid token type.");let s=await this._metadataService.getRevocationEndpoint();if(!s){if(t)throw i.error("TokenRevocationClient.revoke: Revocation not supported"),new Error("Revocation not supported");return}i.debug("TokenRevocationClient.revoke: Revoking "+r);let a=this._settings.client_id,c=this._settings.client_secret;await this._revoke(s,a,c,e,r)}async _revoke(e,t,r,s,a){let c={"Content-Type":"application/x-www-form-urlencoded"},o=new URLSearchParams;o.set("client_id",t),r&&o.set("client_secret",r),o.set("token_type_hint",a),o.set("token",s);let l;try{i.debug("TokenRevocationClient.revoke, url: ",e),l=await fetch(e,{method:"POST",headers:c,body:o})}catch{throw i.error("TokenRevocationClient.revoke: network error"),new Error("Network Error")}if(i.debug("TokenRevocationClient.revoke: HTTP response received, status",l.status),l.status!==200)throw new Error(l.statusText+" ("+l.status.toString()+")")}};var Ne=class{constructor(e){this.settings=new me(e),this._client=new ee(e),this._redirectNavigator=new _e(this.settings),this._popupNavigator=new he(this.settings),this._iframeNavigator=new ge(this.settings),this._events=new V(this.settings),this._silentRenewService=new fe(this),this.settings.automaticSilentRenew&&(i.debug("UserManager.ctor: automaticSilentRenew is configured, setting up silent renew"),this.startSilentRenew()),this._sessionMonitor=null,this.settings.monitorSession&&(i.debug("UserManager.ctor: monitorSession is configured, setting up session monitor"),this._sessionMonitor=new z(this)),this._tokenRevocationClient=new Q(this.settings,this.metadataService),this._tokenClient=new B(this.settings,this.metadataService)}get events(){return this._events}get metadataService(){return this._client.metadataService}async getUser(){let e=await this._loadUser();return e?(i.info("UserManager.getUser: user loaded"),this._events.load(e,!1),e):(i.info("UserManager.getUser: user not found in storage"),null)}async removeUser(){await this.storeUser(null),i.info("UserManager.removeUser: user removed from storage"),this._events.unload()}async signinRedirect(e={}){let{redirectMethod:t,...r}=e,s=await this._redirectNavigator.prepare({redirectMethod:t});await this._signinStart({request_type:"si:r",...r},s),i.info("UserManager.signinRedirect: successful")}async signinRedirectCallback(e=window.location.href){let t=await this._signinEnd(e);return t.profile&&t.profile.sub?i.info("UserManager.signinRedirectCallback: successful, signed in sub: ",t.profile.sub):i.info("UserManager.signinRedirectCallback: no sub"),t}async signinPopup(e={}){let{popupWindowFeatures:t,popupWindowTarget:r,...s}=e,a=this.settings.popup_redirect_uri||this.settings.redirect_uri;if(!a)throw i.error("UserManager.signinPopup: No popup_redirect_uri or redirect_uri configured"),new Error("No popup_redirect_uri or redirect_uri configured");let c=await this._popupNavigator.prepare({popupWindowFeatures:t,popupWindowTarget:r}),o=await this._signin({request_type:"si:p",redirect_uri:a,display:"popup",...s},c);return o&&(o.profile&&o.profile.sub?i.info("UserManager.signinPopup: signinPopup successful, signed in sub: ",o.profile.sub):i.info("UserManager.signinPopup: no sub")),o}async signinPopupCallback(e){try{await this._signinCallback(e,this._popupNavigator),i.info("UserManager.signinPopupCallback: successful")}catch(t){i.error("UserManager.signinPopupCallback error",t instanceof Error?t.message:t)}}async signinSilent(e={}){let{silentRequestTimeoutInSeconds:t,...r}=e,s=await this._loadUser();if(s&&s.refresh_token)return this._useRefreshToken(s);let a=this.settings.silent_redirect_uri||this.settings.redirect_uri;if(!a)throw i.error("UserManager.signinSilent: No silent_redirect_uri configured"),new Error("No silent_redirect_uri configured");let c;s&&this.settings.validateSubOnSilentRenew&&(i.debug("UserManager.signinSilent, subject prior to silent renew: ",s.profile.sub),c=s.profile.sub);let o=await this._iframeNavigator.prepare({silentRequestTimeoutInSeconds:t});return s=await this._signin({request_type:"si:s",redirect_uri:a,prompt:"none",...r},o,c),s&&(s.profile&&s.profile.sub?i.info("UserManager.signinSilent: successful, signed in sub: ",s.profile.sub):i.info("UserManager.signinSilent: no sub")),s}async _useRefreshToken(e){let t=await this._tokenClient.exchangeRefreshToken({refresh_token:e.refresh_token||""});if(!t)throw i.error("UserManager._useRefreshToken: No response returned from token endpoint"),new Error("No response returned from token endpoint");if(!t.access_token)throw i.error("UserManager._useRefreshToken: No access token returned from token endpoint"),new Error("No access token returned from token endpoint");return i.debug("UserManager._useRefreshToken: refresh token response success"),e.access_token=t.access_token||e.access_token,e.refresh_token=t.refresh_token||e.refresh_token,e.expires_in=t.expires_in,await this.storeUser(e),this._events.load(e),e}async signinSilentCallback(e){await this._signinCallback(e,this._iframeNavigator),i.info("UserManager.signinSilentCallback: successful")}async signinCallback(e){let{state:t}=await this._client.readSigninResponseState(e);if(t.request_type==="si:r")return this.signinRedirectCallback(e);if(t.request_type==="si:p")return await this.signinPopupCallback(e),null;if(t.request_type==="si:s")return await this.signinSilentCallback(e),null;throw new Error("invalid response_type in state")}async signoutCallback(e,t=!1){let{state:r}=await this._client.readSignoutResponseState(e);if(r)throw r.request_type==="so:r"&&await this.signoutRedirectCallback(e),r.request_type==="so:p"&&await this.signoutPopupCallback(e,t),new Error("invalid response_type in state")}async querySessionStatus(e={}){let{silentRequestTimeoutInSeconds:t,...r}=e,s=this.settings.silent_redirect_uri||this.settings.redirect_uri;if(!s)throw i.error("UserManager.querySessionStatus: No silent_redirect_uri configured"),new Error("No silent_redirect_uri configured");let a=await this._iframeNavigator.prepare({silentRequestTimeoutInSeconds:t}),c=await this._signinStart({request_type:"si:s",redirect_uri:s,prompt:"none",response_type:this.settings.query_status_response_type,scope:"openid",skipUserInfo:!0,...r},a);try{let o=await this._client.processSigninResponse(c.url);return i.debug("UserManager.querySessionStatus: got signin response"),o.session_state&&o.profile.sub?(i.info("UserManager.querySessionStatus: querySessionStatus success for sub: ",o.profile.sub),{session_state:o.session_state,sub:o.profile.sub,sid:o.profile.sid}):(i.info("querySessionStatus successful, user not authenticated"),null)}catch(o){if(this.settings.monitorAnonymousSession&&o instanceof T&&o.session_state&&(o.message=="login_required"||o.message=="consent_required"||o.message=="interaction_required"||o.message=="account_selection_required"))return i.info("UserManager.querySessionStatus: querySessionStatus success for anonymous user"),{session_state:o.session_state};throw o}}async _signin(e,t,r){let s=await this._signinStart(e,t);return this._signinEnd(s.url,r)}async _signinStart(e,t){i.debug("UserManager._signinStart: got navigator window handle");try{let r=await this._client.createSigninRequest(e);return i.debug("UserManager._signinStart: got signin request"),t.navigate({url:r.url,id:r.state.id})}catch(r){throw i.debug("UserManager._signinStart: Error after preparing navigator, closing navigator window"),t.close(),r}}async _signinEnd(e,t){let r=await this._client.processSigninResponse(e);i.debug("UserManager._signinEnd: got signin response");let s=new O(r);if(t){if(t!==s.profile.sub)throw i.debug("UserManager._signinEnd: current user does not match user returned from signin. sub from signin: ",s.profile.sub),new Error("login_required");i.debug("UserManager._signinEnd: current user matches user returned from signin")}return await this.storeUser(s),i.debug("UserManager._signinEnd: user stored"),this._events.load(s),s}async _signinCallback(e,t){i.debug("UserManager._signinCallback");let s=this.settings.response_mode==="query"||!this.settings.response_mode&&this.settings.response_type==="code"?"?":"#";await t.callback(e,!1,s)}async signoutRedirect(e={}){let{redirectMethod:t,...r}=e,s=await this._redirectNavigator.prepare({redirectMethod:t});await this._signoutStart({request_type:"so:r",post_logout_redirect_uri:this.settings.post_logout_redirect_uri,...r},s),i.info("UserManager.signoutRedirect: successful")}async signoutRedirectCallback(e=window.location.href){let t=await this._signoutEnd(e);return i.info("UserManager.signoutRedirectCallback: successful"),t}async signoutPopup(e={}){let{popupWindowFeatures:t,popupWindowTarget:r,...s}=e,a=this.settings.popup_post_logout_redirect_uri||this.settings.post_logout_redirect_uri,c=await this._popupNavigator.prepare({popupWindowFeatures:t,popupWindowTarget:r});await this._signout({request_type:"so:p",post_logout_redirect_uri:a,state:a==null?void 0:{},...s},c),i.info("UserManager.signoutPopup: successful")}async signoutPopupCallback(e,t=!1){let r="?";await this._popupNavigator.callback(e,t,r),i.info("UserManager.signoutPopupCallback: successful")}async _signout(e,t){let r=await this._signoutStart(e,t);return this._signoutEnd(r.url)}async _signoutStart(e={},t){var r;i.debug("UserManager._signoutStart: got navigator window handle");try{let s=await this._loadUser();i.debug("UserManager._signoutStart: loaded current user from storage"),this.settings.revokeAccessTokenOnSignout&&await this._revokeInternal(s),await this.removeUser(),i.debug("UserManager._signoutStart: user removed, creating signout request");let a=await this._client.createSignoutRequest(e);return i.debug("UserManager._signoutStart: got signout request"),t.navigate({url:a.url,id:(r=a.state)==null?void 0:r.id})}catch(s){throw i.debug("UserManager._signoutStart: Error after preparing navigator, closing navigator window"),t.close(),s}}async _signoutEnd(e){let t=await this._client.processSignoutResponse(e);return i.debug("UserManager._signoutEnd: got signout response"),t}async revokeAccessToken(){let e=await this._loadUser();await this._revokeInternal(e,!0)&&e&&(i.debug("UserManager.revokeAccessToken: removing token properties from user and re-storing"),e.access_token="",e.refresh_token="",e.expires_at=0,e.token_type="",await this.storeUser(e),i.debug("UserManager.revokeAccessToken: user stored"),this._events.load(e)),i.info("UserManager.revokeAccessToken: access token revoked successfully")}async _revokeInternal(e,t=!1){if(e){let r=e.access_token,s=e.refresh_token,a=await this._revokeAccessTokenInternal(r,t),c=await this._revokeRefreshTokenInternal(s,t);return!a&&!c&&i.debug("UserManager.revokeAccessToken: no need to revoke due to no token(s), or JWT format"),a||c}return!1}async _revokeAccessTokenInternal(e,t){return!e||e.includes(".")?!1:(await this._tokenRevocationClient.revoke(e,t),!0)}async _revokeRefreshTokenInternal(e,t){return e?(await this._tokenRevocationClient.revoke(e,t,"refresh_token"),!0):!1}startSilentRenew(){this._silentRenewService.start()}stopSilentRenew(){this._silentRenewService.stop()}get _userStoreKey(){return`user:${this.settings.authority}:${this.settings.client_id}`}async _loadUser(){let e=await this.settings.userStore.get(this._userStoreKey);return e?(i.debug("UserManager._loadUser: user storageString loaded"),O.fromStorageString(e)):(i.debug("UserManager._loadUser: no user storageString"),null)}async storeUser(e){if(e){i.debug("UserManager.storeUser: storing user");let t=e.toStorageString();await this.settings.userStore.set(this._userStoreKey,t)}else i.debug("storeUser.storeUser: removing user"),await this.settings.userStore.remove(this._userStoreKey)}async clearStaleState(){await this._client.clearStaleState()}};var Ae="2.0.0-beta.2.F138";var qe=Ae;return gt;})();
